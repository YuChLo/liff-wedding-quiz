<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å©šç¦®å•ç­” Host</title>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#0b0f1a;color:#eaf0ff}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.card{background:#121a2b;border:1px solid #223055;border-radius:16px;padding:16px;margin:12px 0}
input,button,textarea{font-size:16px} input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3b66;background:#0f1626;color:#eaf0ff}
button{padding:12px 14px;border-radius:12px;border:0;font-weight:900}
.primary{background:#22c55e;color:#06101f}.secondary{background:#3b82f6;color:#fff}.danger{background:#ef4444;color:#fff}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.col{flex:1;min-width:260px}
.big{font-size:22px;font-weight:900}.muted{opacity:.75}
code{background:#0f1626;border:1px solid #2a3b66;border-radius:10px;padding:4px 8px;display:inline-block}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #223055;text-align:left}
</style></head><body>
<div class="wrap">
  <div class="row" style="justify-content:space-between"><div class="big">ä¸»æŒå°</div><div class="muted" id="conn">é€£ç·šä¸­â€¦</div></div>

  <div class="card">
    <div class="row">
      <div class="col"><div class="muted">ADMIN_KEY</div><input id="adminKey" placeholder="å¡« .env çš„ ADMIN_KEY"/></div>
      <div class="col"><div class="muted">ä¸»æŒäººåç¨±</div><input id="hostName" placeholder="å¯ç•™ç©º"/></div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button class="secondary" id="createBtn">å»ºç«‹æˆ¿é–“</button>
      <input id="joinCode" placeholder="æˆ¿é–“ç¢¼ï¼ˆé‡é€£ç”¨ï¼‰" style="max-width:240px"/>
      <button class="secondary" id="joinBtn">åŠ å…¥æˆ¿é–“</button>
    </div>
    <p class="muted" id="hint"></p>
  </div>

  <div class="card" id="roomCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">æˆ¿é–“ç¢¼</div><div class="big" id="code">â€”</div>
        <div class="muted">ç©å®¶åŠ å…¥é </div><code id="joinUrl">â€”</code>
      </div>
      <div style="text-align:right">
        <div class="muted">å›è¦†æ•¸</div><div class="big" id="answers">0</div>
        <div class="muted">ç‹€æ…‹</div><div class="big" id="state">â€”</div>
      </div>
    </div>
    <hr style="border:0;border-top:1px solid #223055;margin:14px 0"/>
    <div class="row">
      <button class="secondary" id="startBtn">é–‹å§‹ï¼ˆ15sï¼‰</button>
      <button class="danger" id="revealBtn">æå‰æ­æ›‰</button>
      <button class="primary" id="nextBtn">ä¸‹ä¸€é¡Œ</button>
      <a id="display" href="#" target="_blank" class="muted">é–‹æŠ•å½±é </a>
    </div>
    <div style="height:12px"></div>
    <div class="muted" id="progress">â€”</div>
    <div class="big" id="q">â€”</div>
    <div class="muted" id="choices">â€”</div>

    <div style="height:16px"></div>
    <div class="row">
      <div class="col">
        <div class="big">æ’è¡Œæ¦œï¼ˆå‰10ï¼‰</div>
        <table><thead><tr><th>#</th><th>ç©å®¶</th><th>åˆ†æ•¸</th><th>é€£ç·š</th></tr></thead><tbody id="lb"></tbody></table>
      </div>
      <div class="col">
        <div class="big">è‡ªè¨‚é¡Œåº« JSON</div>
        <div class="muted">æ ¼å¼ï¼š[{ "text":"é¡Œç›®","choices":["A","B","C","D"],"correctIndex":0 }]</div>
        <textarea id="qJson" rows="10"></textarea>
        <div style="height:10px"></div>
        <button class="secondary" id="setQBtn">å¥—ç”¨é¡Œåº«</button>
        <div class="muted" id="qHint"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
let socket, roomCode="", baseUrl="", adminKey="", liffName="";
function setConn(ok){$("conn").textContent=ok?"å·²é€£ç·š":"æœªé€£ç·š";}
async function cfg(){const r=await fetch("/config?role=host"); return r.json();}
async function initLiff(liffId){
  try{
    await liff.init({ liffId });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const p=await liff.getProfile();
    liffName=p.displayName||"";
  }catch(e){}
}
function esc(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
function update(s){
  roomCode=s.code;
  $("roomCard").style.display="";
  $("code").textContent=s.code;
  $("state").textContent=s.state;
  $("answers").textContent=s.answersCount||0;

  const origin = baseUrl || location.origin;
  $("joinUrl").textContent = origin + "/player.html";
  $("display").href = origin + "/display.html?code=" + encodeURIComponent(s.code);

  $("progress").textContent = "ç¬¬ " + (s.qIndex+1) + " / " + s.total + " é¡Œ";
  if(s.question){
    $("q").textContent=s.question.text;
    const c=s.question.choices;
    $("choices").textContent = "A " + c[0] + " | B " + c[1] + " | C " + c[2] + " | D " + c[3];
  } else { $("q").textContent="â€”"; $("choices").textContent="â€”"; }

  const lb=$("lb"); lb.innerHTML="";
  (s.players||[]).slice(0,10).forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = "<td>" + (i+1) + "</td><td>" + esc(p.name) + "</td><td>" + p.score + "</td><td>" + (p.connected ? "ğŸŸ¢" : "âšª") + "</td>";
    lb.appendChild(tr);
  });
}

function sampleQs(){
  return [
    {"text":"æ–°éƒç¬¬ä¸€æ¬¡è¦‹åˆ°æ–°å¨˜ï¼Œå¿ƒè£¡æƒ³ï¼Ÿ","choices":["å¤©å•Šå¥½æ¼‚äº®","å¥¹å¾ˆé…·","å¥¹å¾ˆå…‡","å…ˆåƒå†èªª"],"correctIndex":0},
    {"text":"å…©äººæœ€å¸¸ä¸€èµ·åšçš„äº‹ï¼Ÿ","choices":["è¿½åŠ‡","é‹å‹•","æ‰“é›»å‹•","æ•£æ­¥"],"correctIndex":0}
  ];
}

(async ()=>{
  const c = await cfg();
  baseUrl = c.baseUrl || "";
  await initLiff(c.liffId||"");
  if(liffName && !$("hostName").value) $("hostName").value=liffName;

  socket=io();
  socket.on("connect",()=>setConn(true));
  socket.on("disconnect",()=>setConn(false));
  socket.on("room:update",(snap)=>{ if(roomCode && snap.code!==roomCode) return; update(snap); });
  socket.on("room:answersCount",(p)=>{ $("answers").textContent=p.answersCount||$("answers").textContent; });

  $("qJson").value = JSON.stringify(sampleQs(), null, 2);

  $("createBtn").onclick=()=>{
    adminKey=$("adminKey").value.trim();
    const hostName=$("hostName").value.trim()||"Host";
    $("hint").textContent="å»ºç«‹ä¸­â€¦";
    socket.emit("host:create",{adminKey,hostName},(res)=>{
      if(!(res && res.ok)){ $("hint").textContent="å¤±æ•—ï¼š"+(res.error||""); return; }
      $("hint").textContent="âœ… å·²å»ºç«‹";
      update(res.room);
    });
  };

  $("joinBtn").onclick=()=>{
    adminKey=$("adminKey").value.trim();
    const code=$("joinCode").value.trim().toUpperCase();
    const hostName=$("hostName").value.trim()||"Host";
    $("hint").textContent="åŠ å…¥ä¸­â€¦";
    socket.emit("host:join",{adminKey,code,hostName},(res)=>{
      if(!(res && res.ok)){ $("hint").textContent="å¤±æ•—ï¼š"+(res.error||""); return; }
      $("hint").textContent="âœ… å·²åŠ å…¥";
      update(res.room);
    });
  };

  $("startBtn").onclick=()=> socket.emit("host:start",{adminKey,code:roomCode,durationMs:15000},(r)=>{ if(!(r && r.ok)) alert(r.error||"å¤±æ•—"); });
  $("revealBtn").onclick=()=> socket.emit("host:reveal",{adminKey,code:roomCode},(r)=>{ if(!(r && r.ok)) alert(r.error||"å¤±æ•—"); });
  $("nextBtn").onclick=()=> socket.emit("host:next",{adminKey,code:roomCode},(r)=>{ if(!(r && r.ok)) alert(r.error||"å¤±æ•—"); });

  $("setQBtn").onclick=()=>{
    try{
      const qs=JSON.parse($("qJson").value);
      $("qHint").textContent="å¥—ç”¨ä¸­â€¦";
      socket.emit("host:setQuestions",{adminKey,code:roomCode,questions:qs},(r)=>{
        $("qHint").textContent = (r && r.ok) ? "âœ… å·²å¥—ç”¨" : ("å¤±æ•—ï¼š"+((r && r.error)||""));
      });
    }catch(e){ $("qHint").textContent="JSON æ ¼å¼éŒ¯èª¤"; }
  };
})();
</script></body></html>
