<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å©šç¦®å•ç­” Host</title>
<style>
    *,*::before,*::after{box-sizing:border-box}

body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#0b0f1a;color:#eaf0ff}
.wrap{max-width:980px;margin:0 auto;padding:16px}
.card{background:#121a2b;border:1px solid #223055;border-radius:16px;padding:16px;margin:12px 0}
input,button,textarea{font-size:16px} input,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3b66;background:#0f1626;color:#eaf0ff}
button{padding:12px 14px;border-radius:12px;border:0;font-weight:900}
.primary{background:#22c55e;color:#06101f}.secondary{background:#3b82f6;color:#fff}.danger{background:#ef4444;color:#fff}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.col{flex:1;min-width:260px}
.big{font-size:22px;font-weight:900}.muted{opacity:.75}
code{background:#0f1626;border:1px solid #2a3b66;border-radius:10px;padding:4px 8px;display:inline-block}
table{width:100%;border-collapse:collapse} th,td{padding:8px;border-bottom:1px solid #223055;text-align:left}
.avatar{width:28px;height:28px;border-radius:50%;vertical-align:middle;margin-right:8px;object-fit:cover;background:#0f1626;border:1px solid #2a3b66}

    input,button,select{max-width:100%}
    .row{min-width:0}
    .row > *{min-width:0}

</style></head><body>
<div class="wrap">
  <div class="row" style="justify-content:space-between"><div class="big">ä¸»æŒå°</div><div class="muted" id="conn">é€£ç·šä¸­â€¦</div></div>

  <div class="card">
    <div class="row">
      <div class="col"><div class="muted">ADMIN_KEY</div><input id="adminKey" placeholder="å¡« .env çš„ ADMIN_KEY"/></div>
      <div class="col"><div class="muted">ä¸»æŒäººåç¨±</div><input id="hostName" placeholder="å¯ç•™ç©º"/></div>
    </div>
    <div style="height:10px"></div>
    <div class="row">
      <button class="secondary" id="createBtn">å»ºç«‹æˆ¿é–“</button>
      <input id="joinCode" placeholder="æˆ¿é–“ç¢¼ï¼ˆé‡é€£ç”¨ï¼‰" style="max-width:240px"/>
      <button class="secondary" id="joinBtn">åŠ å…¥æˆ¿é–“</button>
    </div>
    <p class="muted" id="hint"></p>
  </div>

  <div class="card" id="roomCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div>
        <div class="muted">æˆ¿é–“ç¢¼</div><div class="big" id="code">â€”</div>
        <div class="muted">ç©å®¶åŠ å…¥é </div><code id="joinUrl">â€”</code>
      </div>
      <div style="text-align:right">
        <div class="muted">å›è¦†æ•¸</div><div class="big" id="answers">0</div>
        <div class="muted">ç‹€æ…‹</div><div class="big" id="state">â€”</div>
      </div>
    </div>
    <hr style="border:0;border-top:1px solid #223055;margin:14px 0"/>
    <div class="row">
      <button class="secondary" id="startBtn">é–‹å§‹ï¼ˆ15sï¼‰</button>
      <button class="danger" id="revealBtn">æå‰æ­æ›‰</button>
      <button class="primary" id="nextBtn">ä¸‹ä¸€é¡Œ</button>
      <button class="secondary" id="displayBtn">é–‹æŠ•å½±é </button>
      <button class="primary" id="qrBtn" type="button">é–‹ QR é </button>
    </div>
    <div style="height:12px"></div>
    <div class="muted" id="progress">â€”</div>
    <div class="big" id="q">â€”</div>
    <div class="muted" id="choices">â€”</div>

    <div style="height:16px"></div>
    <div class="row">
      <div class="col">
        <div class="big">æ’è¡Œæ¦œï¼ˆå‰10ï¼‰</div>
        <table><thead><tr><th>#</th><th>ç©å®¶</th><th>åˆ†æ•¸</th><th>é€£ç·š</th></tr></thead><tbody id="lb"></tbody></table>
      </div>
    </div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
(function () {
  function $(id) { return document.getElementById(id); }

  var socket = null;
  var roomCode = "";
  var baseUrl = "";
  var adminKey = "";
  var liffName = "";

  function setConn(ok) { $("conn").textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š"; }

  function esc(s) {
    s = String(s);
    return s.replace(/[&<>"']/g, function (m) {
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
    });
  }

  function cfg(cb) {
    fetch("/config?role=host")
      .then(function (r) { return r.json(); })
      .then(function (j) { cb(null, j); })
      .catch(function (e) { cb(e); });
  }

  function initLiff(liffId, done) {
    if (!window.liff || !liffId) return done(); // æ²’æœ‰ LIFF ä¹Ÿå¯åœ¨ç€è¦½å™¨æ¸¬è©¦
    liff.init({ liffId: liffId }).then(function () {
      if (!liff.isLoggedIn()) { liff.login(); return; }
      return liff.getProfile().then(function (p) {
        liffName = (p && p.displayName) ? p.displayName : "";
        done();
      }).catch(function () { done(); });
    }).catch(function () { done(); });
  }

  function update(s) {
    roomCode = s.code;
    $("roomCard").style.display = "";
    $("code").textContent = s.code;
    $("state").textContent = s.state;
    $("answers").textContent = s.answersCount || 0;
    $("nextBtn").disabled = (s.state === "ended");

    var origin = baseUrl || location.origin;
    $("joinUrl").textContent = origin + "/player.html?code=" + encodeURIComponent(s.code);
    (function(){
      var displayUrl = origin + "/display.html?code=" + encodeURIComponent(s.code);
      var qrUrl = origin + "/qr.html?code=" + encodeURIComponent(s.code);

      var dispEl = document.getElementById("display") || document.getElementById("displayBtn");
      if (dispEl) {
        if (typeof dispEl.href !== "undefined") dispEl.href = displayUrl;
        else dispEl.onclick = function(){ window.open(displayUrl, "_blank"); };
      }

      var qrEl = document.getElementById("qr") || document.getElementById("qrBtn");
      if (qrEl) {
        if (typeof qrEl.href !== "undefined") qrEl.href = qrUrl;
        else qrEl.onclick = function(){ window.open(qrUrl, "_blank"); };
      }
    })();
$("progress").textContent = "ç¬¬ " + (s.qIndex + 1) + " / " + s.total + " é¡Œ";
    if (s.question) {
      $("q").textContent = s.question.text;
      var c = s.question.choices;
      $("choices").textContent = "A " + c[0] + " | B " + c[1] + " | C " + c[2] + " | D " + c[3];
    } else {
      $("q").textContent = "â€”";
      $("choices").textContent = "â€”";
    }

    var lb = $("lb");
    lb.innerHTML = "";
    var players = s.players || [];
    for (var i = 0; i < Math.min(10, players.length); i++) {
      var p = players[i];
      var tr = document.createElement("tr");
      tr.innerHTML =
        "<td>" + (i + 1) + "</td>" +
        "<td>" + (p.avatarUrl ? ('<img class="avatar" referrerpolicy="no-referrer" src="' + esc(p.avatarUrl) + '"/>') : "") + esc(p.name) + "</td>" +
        "<td>" + p.score + "</td>" +
        "<td>" + (p.connected ? "ğŸŸ¢" : "âšª") + "</td>";
      lb.appendChild(tr);
    }
  }

  function sampleQs20() {
    var out = [];
    for (var i = 1; i <= 20; i++) {
      out.push({ text: "ç¬¬" + i + "é¡Œï¼šè«‹æ›æˆä½ å€‘çš„æ•…äº‹", choices: ["A","B","C","D"], correctIndex: 0 });
    }
    return out;
  }

  function boot(c) {
    baseUrl = c.baseUrl || "";

    if (liffName && !$("hostName").value) $("hostName").value = liffName;

    socket = io();
    socket.on("connect", function () { setConn(true); });
    socket.on("disconnect", function () { setConn(false); });
    socket.on("room:update", function (snap) {
      if (roomCode && snap.code !== roomCode) return;
      update(snap);
    });
    socket.on("room:answersCount", function (p) {
      $("answers").textContent = (p && p.answersCount) ? p.answersCount : $("answers").textContent;
    });
    $("createBtn").onclick = function () {
      adminKey = $("adminKey").value.trim();
      var hostName = ($("hostName").value.trim() || "Host");
      $("hint").textContent = "å»ºç«‹ä¸­â€¦";
      socket.emit("host:create", { adminKey: adminKey, hostName: hostName }, function (res) {
        if (!(res && res.ok)) { $("hint").textContent = "å¤±æ•—ï¼š" + ((res && res.error) || ""); return; }
        $("hint").textContent = "âœ… å·²å»ºç«‹";
        update(res.room);
      });
    };

    $("joinBtn").onclick = function () {
      adminKey = $("adminKey").value.trim();
      var code = $("joinCode").value.trim().toUpperCase();
      var hostName = ($("hostName").value.trim() || "Host");
      $("hint").textContent = "åŠ å…¥ä¸­â€¦";
      socket.emit("host:join", { adminKey: adminKey, code: code, hostName: hostName }, function (res) {
        if (!(res && res.ok)) { $("hint").textContent = "å¤±æ•—ï¼š" + ((res && res.error) || ""); return; }
        $("hint").textContent = "âœ… å·²åŠ å…¥";
        update(res.room);
      });
    };

    $("startBtn").onclick = function () {
      socket.emit("host:start", { adminKey: adminKey, code: roomCode, durationMs: 15000 }, function (r) {
        if (!(r && r.ok)) alert((r && r.error) || "å¤±æ•—");
      });
    };
    $("revealBtn").onclick = function () {
      socket.emit("host:reveal", { adminKey: adminKey, code: roomCode }, function (r) {
        if (!(r && r.ok)) alert((r && r.error) || "å¤±æ•—");
      });
    };
    $("nextBtn").onclick = function () {
      socket.emit("host:next", { adminKey: adminKey, code: roomCode }, function (r) {
        if (!(r && r.ok)) alert((r && r.error) || "å¤±æ•—");
      });
    };
  }

  // å•Ÿå‹•æµç¨‹ï¼šå…ˆæŠ“ config â†’ init liff â†’ boot socket
  cfg(function (err, c) {
    if (err) { $("conn").textContent = "è¨­å®šè®€å–å¤±æ•—"; return; }
    initLiff(c.liffId || "", function () { boot(c); });
  });

})();
</script></body></html>
