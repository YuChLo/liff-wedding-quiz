<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å©šç¦®å•ç­” Player</title>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#0b0f1a;color:#eaf0ff}
.wrap{max-width:720px;margin:0 auto;padding:16px}
.card{background:#121a2b;border:1px solid #223055;border-radius:16px;padding:16px;margin:12px 0}
input,button{font-size:16px} input{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3b66;background:#0f1626;color:#eaf0ff}
button{width:100%;padding:12px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:800}
.choice{width:100%;text-align:left;background:#0f1626;border:2px solid #2a3b66;border-radius:14px;padding:14px}
.good{border-color:#22c55e}.bad{border-color:#ef4444}
.row{display:flex;justify-content:space-between;align-items:center;gap:10px}
.big{font-size:22px;font-weight:900}.muted{opacity:.75}
.grid{display:grid;gap:10px}
</style></head><body>
<div class="wrap">
  <div class="row"><div class="big">å©šç¦®å•ç­”</div><div class="muted" id="conn">é€£ç·šä¸­â€¦</div></div>

  <div class="card" id="joinCard">
    <div class="big">åŠ å…¥æˆ¿é–“</div>
    <p class="muted" id="hint">è«‹è¼¸å…¥æˆ¿é–“ç¢¼</p>
    <input id="code" placeholder="ABC123"/>
    <div style="height:8px"></div>
    <input id="name" placeholder="æš±ç¨±ï¼ˆå¯ç•™ç©ºï¼‰"/>
    <div style="height:10px"></div>
    <button id="joinBtn">åŠ å…¥</button>
  </div>

  <div class="card" id="gameCard" style="display:none">
    <div class="row"><div><div class="muted">æˆ¿é–“</div><div class="big" id="room">â€”</div></div>
      <div style="text-align:right"><div class="muted">å€’æ•¸</div><div class="big" id="timer">â€”</div></div>
    </div>
    <hr style="border:0;border-top:1px solid #223055;margin:14px 0"/>
    <div class="muted" id="progress">â€”</div>
    <div class="big" id="q">ç­‰å¾…é¡Œç›®â€¦</div>
    <div style="height:12px"></div>
    <div class="grid" id="choices"></div>
    <div style="height:12px"></div>
    <div class="muted" id="status">ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦</div>
  </div>
</div>

<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
let socket, roomCode="", userId="", displayName="";
let state="lobby", startAt=0, durationMs=0, answered=false, correctIndex=null, currentChoices=[];
function setConn(ok){$("conn").textContent = ok?"å·²é€£ç·š":"æœªé€£ç·š";}
async function cfg(){const r=await fetch("/config?role=player"); return r.json();}
async function initLiff(liffId){
  try{
    await liff.init({ liffId });
    if(!liff.isLoggedIn()){ liff.login(); return; }
    const p=await liff.getProfile();
    userId=p.userId; displayName=p.displayName||"";
  }catch(e){
    userId="guest-"+Math.random().toString(16).slice(2);
    $("hint").textContent="âš ï¸ ä¼¼ä¹ä¸æ˜¯åœ¨ LINE LIFFï¼Œå·²ç”¨è¨ªå®¢æ¨¡å¼ï¼ˆä»å¯æ¸¬è©¦ï¼‰";
  }
}
function renderChoices(){
  const wrap=$("choices"); wrap.innerHTML="";
  const labels=["A","B","C","D"];
  currentChoices.forEach((c,i)=>{
    const b=document.createElement("button");
    b.className="choice";
    b.disabled = (state!=="question") || answered;
    b.innerHTML = '<div class="muted">' + labels[i] + '</div><div style="font-size:18px;font-weight:900">' + esc(c) + "</div>";
    b.onclick=()=>sendAns(i);
    wrap.appendChild(b);
  });
}
function esc(s){return String(s).replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));}
function onUpdate(s){
  roomCode=s.code; state=s.state; startAt=s.startAt||0; durationMs=s.durationMs||0;
  $("room").textContent=s.code;
  $("progress").textContent = "ç¬¬ " + (s.qIndex+1) + " / " + s.total + " é¡Œ";
  if(s.question){ $("q").textContent=s.question.text; currentChoices=s.question.choices||[]; renderChoices(); }
  else { $("q").textContent="ç­‰å¾…é¡Œç›®â€¦"; $("choices").innerHTML=""; }
  if(state==="lobby"){ answered=false; correctIndex=null; $("status").textContent="ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦"; }
  if(state==="question"){ answered=false; correctIndex=null; $("status").textContent="è«‹é¸æ“‡ç­”æ¡ˆï¼"; }
  if(state==="reveal"){ $("status").textContent="æ­æ›‰ï¼"; }
  if(state==="ended"){ $("status").textContent="ğŸ‰ çµæŸï¼"; }
}
function sendAns(i){
  if(answered||state!=="question") return;
  answered=true; $("status").textContent="âœ… å·²é€å‡ºï¼Œç­‰å¾…æ­æ›‰â€¦";
  socket.emit("player:answer",{code:roomCode,userId,choiceIndex:i},(res)=>{ if(!(res && res.ok)) $("status").textContent="âš ï¸ "+(res.error||"é€å‡ºå¤±æ•—"); });
  renderChoices();
}
setInterval(()=>{
  if(state!=="question"){ $("timer").textContent="â€”"; return; }
  const remain=Math.max(0,(startAt+durationMs)-Date.now());
  $("timer").textContent=Math.ceil(remain/1000)+"s";
},200);

(async ()=>{
  const c = await cfg();
  await initLiff(c.liffId||"");
  socket=io();
  socket.on("connect",()=>setConn(true));
  socket.on("disconnect",()=>setConn(false));
  socket.on("room:update",onUpdate);
  socket.on("question:reveal",(p)=>{
    correctIndex=p.correctIndex;
    // mark correct on UI
    const nodes=[...document.querySelectorAll(".choice")];
    nodes.forEach((n,idx)=>{ n.classList.remove("good","bad"); if(idx===correctIndex) n.classList.add("good"); else if(answered) n.classList.add("bad"); n.disabled=true; });
  });
  $("joinBtn").onclick=()=>{
    const code=$("code").value.trim().toUpperCase();
    const name=($("name").value.trim()||displayName||"Guest");
    if(!code){ $("hint").textContent="è«‹è¼¸å…¥æˆ¿é–“ç¢¼"; return; }
    socket.emit("player:join",{code,userId,name},(res)=>{
      if(!(res && res.ok)){ $("hint").textContent="åŠ å…¥å¤±æ•—ï¼š"+(res.error||""); return; }
      $("joinCard").style.display="none"; $("gameCard").style.display="";
      onUpdate(res.room);
    });
  };
})();
</script></body></html>
