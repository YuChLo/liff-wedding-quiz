<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å©šç¦®å•ç­” Player</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}

    body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#0b0f1a;color:#eaf0ff}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#121a2b;border:1px solid #223055;border-radius:16px;padding:16px;margin:12px 0}
    input,button{font-size:16px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3b66;background:#0f1626;color:#eaf0ff}
    button{width:100%;padding:12px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:800}
    .choice{position:relative;width:100%;text-align:left;background:#0f1626;border:2px solid #2a3b66;border-radius:14px;padding:14px}
    .good{border-color:#22c55e}.bad{border-color:#ef4444}.picked{border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,.25)}.pickedWrong{border-color:#f59e0b;box-shadow:0 0 0 2px rgba(245,158,11,.25)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .big{font-size:22px;font-weight:900}
    .muted{opacity:.75}
    .grid{display:grid;gap:10px}
    input.readonly{opacity:.85}

  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="big">å©šç¦®å•ç­”</div>
      <div class="muted" id="conn">é€£ç·šä¸­â€¦</div>
    </div>

    <div class="card" id="joinCard">
      <div class="big">åŠ å…¥æˆ¿é–“</div>
      <p class="muted" id="hint">è«‹è¼¸å…¥å·¥è™Ÿï¼ˆåƒ…æ•¸å­— 4~10 ç¢¼ï¼‰</p>
      <input id="code" placeholder="ABC123"/>
      <div style="height:10px"></div>
      <input id="emp" placeholder="è«‹è¼¸å…¥å·¥è™Ÿï¼ˆ4~10 ç¢¼æ•¸å­—ï¼‰" inputmode="numeric" pattern="[0-9]*"/>
      <div style="height:10px"></div>
      <button id="joinBtn">åŠ å…¥</button>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <div class="row">
        <div>
          <div class="muted">æˆ¿é–“</div>
          <div class="big" id="room">â€”</div>
        </div>
        <div style="text-align:right">
          <div class="muted">å€’æ•¸</div>
          <div class="big" id="timer">â€”</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #223055;margin:14px 0"/>

      <div class="muted" id="progress">â€”</div>
      <div class="big" id="q">ç­‰å¾…é¡Œç›®â€¦</div>
      <div style="height:12px"></div>
      <div class="grid" id="choices"></div>
      <div style="height:12px"></div>
      <div class="muted" id="status">ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function () {
    function $(id){ return document.getElementById(id); }
    function setConn(ok){ $("conn").textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š"; }

    function esc(s){
      return String(s).replace(/[&<>"']/g, function(m){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
      });
    }

    var params = new URLSearchParams(location.search);
    var socket = null;

    var roomCode = "";
    var userId = "";
    var state = "lobby";
    var currentQIndex = -999;
    var startAt = 0;
    var durationMs = 0;
    var answered = false;
    var pickedIndex = null;
    var correctIndex = null;
    var currentChoices = [];

    function onUpdate(s){
      roomCode = s.code;
      state = s.state;

      // Hide question until host starts (lobby)
      if (state === "lobby" || !s.question) {
        const qEl = document.getElementById("q");
        if (qEl) qEl.textContent = "ç­‰å¾…ä¸»æŒäººæŒ‰ã€Œä¸‹ä¸€é¡Œã€é–‹å§‹â€¦";
        const choicesEl = document.getElementById("choices");
        if (choicesEl) choicesEl.innerHTML = "";
        const progEl = document.getElementById("progress");
        if (progEl) progEl.textContent = "ç­‰å¾…é–‹å§‹";
        const stEl = document.getElementById("status");
        if (stEl) stEl.textContent = "ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦";
      }
      startAt = s.startAt || 0;
      durationMs = s.durationMs || 0;

      $("room").textContent = s.code;
      $("progress").textContent = "ç¬¬ " + (Math.max(0,(s.qIndex||-1)+1)) + " / " + s.total + " é¡Œ";

      if (s.question){
        $("q").textContent = s.question.text;
        currentChoices = s.question.choices || [];
        renderChoices();
      } else {
        $("q").textContent = (state==="ended") ? "ç­‰å¾…çµæœâ€¦" : "ç­‰å¾…é¡Œç›®â€¦";
        $("choices").innerHTML = "";
      }

      if (state === "lobby"){ $("status").textContent = "ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦"; }
      if (state === "question"){ $("status").textContent = answered ? "âœ… å·²é€å‡ºï¼Œç­‰å¾…æ­æ›‰â€¦" : "è«‹é¸æ“‡ç­”æ¡ˆï¼"; }
      if (state === "reveal"){ $("status").textContent = "æ­æ›‰ï¼"; }
      if (state === "ended"){ $("status").textContent = "ğŸ‰ çµæŸï¼"; $("q").textContent = "ç­‰å¾…çµæœâ€¦"; $("choices").innerHTML=""; }
    }

    function renderChoices(){
      var wrap = $("choices");
      wrap.innerHTML = "";
      var labels = ["A","B","C","D"];

      for (var i=0;i<currentChoices.length;i++){
        (function(idx){
          var c = currentChoices[idx];
          var b = document.createElement("button");
          b.className = "choice";
      if(pickedIndex===idx) b.classList.add("picked");
      if(state==="reveal" && correctIndex!==null){
        if(idx===correctIndex) b.classList.add("good");
        else b.classList.add("bad");
        if(pickedIndex===idx && pickedIndex!==correctIndex) b.classList.add("pickedWrong");
      }
          b.disabled = (state !== "question") || answered;
          b.innerHTML = '<div class="muted">' + labels[idx] + '</div>'
                      + '<div style="font-size:18px;font-weight:900">' + esc(c) + '</div>';
          b.onclick = function(){ sendAns(idx); };
          wrap.appendChild(b);
        })(i);
      }
    }

    function validateEmp(emp){
      if (!/^[0-9]+$/.test(emp)) return "å·¥è™Ÿåªèƒ½è¼¸å…¥æ•¸å­—ï¼ˆä¸å¯è‹±æ–‡/ç¬¦è™Ÿï¼‰";
      if (emp.length < 4 || emp.length > 10) return "å·¥è™Ÿé•·åº¦éœ€ 4~10 ç¢¼";
      return "";
    }

    function joinRoom(){
      var code = ($("code").value || "").trim().toUpperCase();
      var emp  = ($("emp").value  || "").trim();

      if(!code){ $("hint").textContent="è«‹è¼¸å…¥æˆ¿é–“ç¢¼"; return; }

      var msg = validateEmp(emp);
      if (msg){ $("hint").textContent = msg; return; }

      $("hint").textContent="åŠ å…¥ä¸­â€¦";

      userId = "emp-" + emp;

      socket.emit("player:join", {
        code: code,
        userId: userId,
        name: emp
      }, function(res){
        if(!(res && res.ok)){
          $("hint").textContent="åŠ å…¥å¤±æ•—ï¼š" + ((res && res.error) || "");
          return;
        }
        $("joinCard").style.display="none";
        $("gameCard").style.display="";
        onUpdate(res.room);
      });
    }

    function sendAns(choiceIdx){
      if (answered || state !== "question") return;
      answered = true;
      pickedIndex = choiceIdx;
      renderChoices();
      $("status").textContent = "âœ… å·²é€å‡ºï¼Œç­‰å¾…æ­æ›‰â€¦";

      socket.emit("player:answer", { code: roomCode, userId: userId, choiceIndex: choiceIdx }, function(res){
        if (!(res && res.ok)) $("status").textContent = "âš ï¸ " + ((res && res.error) || "é€å‡ºå¤±æ•—");
      });
      renderChoices();
    }

    setInterval(function(){
      if (state !== "question"){ $("timer").textContent = "â€”"; return; }
      var remain = Math.max(0, (startAt + durationMs) - Date.now());
      $("timer").textContent = Math.ceil(remain/1000) + "s";
    }, 200);

    function boot(){
      socket = io();

      var urlCode = (params.get("code") || "").trim().toUpperCase();
      if (urlCode) {
        $("code").value = urlCode;
        $("code").readOnly = true;
        $("code").classList.add("readonly");
      }

      socket.on("connect", function(){ setConn(true); });
      socket.on("disconnect", function(){ setConn(false); });
      socket.on("room:update", onUpdate);

      socket.on("question:reveal", function(p){
        correctIndex = p.correctIndex;
        var nodes = Array.prototype.slice.call(document.querySelectorAll(".choice"));
        for (var i=0;i<nodes.length;i++){
          nodes[i].classList.remove("good","bad");
          if (i === correctIndex) nodes[i].classList.add("good");
          else if (answered) nodes[i].classList.add("bad");
          nodes[i].disabled = true;
        }
      });

      $("joinBtn").onclick = joinRoom;
      $("emp").addEventListener("keydown", function(e){
        if (e.key === "Enter") joinRoom();
      });
    }

    boot();
  })();
  </script>

</body>
</html>
