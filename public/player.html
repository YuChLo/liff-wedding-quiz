<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å©šç¦®å•ç­” Player</title>
  <style>
    body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#0b0f1a;color:#eaf0ff}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#121a2b;border:1px solid #223055;border-radius:16px;padding:16px;margin:12px 0}
    input,button{font-size:16px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3b66;background:#0f1626;color:#eaf0ff}
    button{width:100%;padding:12px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:800}
    .choice{width:100%;text-align:left;background:#0f1626;border:2px solid #2a3b66;border-radius:14px;padding:14px}
    .good{border-color:#22c55e}.bad{border-color:#ef4444}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .big{font-size:22px;font-weight:900}
    .muted{opacity:.75}
    .grid{display:grid;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="big">å©šç¦®å•ç­”</div>
      <div class="muted" id="conn">é€£ç·šä¸­â€¦</div>
    </div>

    <div class="card" id="joinCard">
      <div class="big">åŠ å…¥æˆ¿é–“</div>
      <p class="muted" id="hint">å°‡è‡ªå‹•ä½¿ç”¨ LINE åç¨±èˆ‡é ­åƒ</p>
      <input id="code" placeholder="ABC123"/>
      <div style="height:10px"></div>
      <button id="joinBtn">åŠ å…¥</button>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <div class="row">
        <div>
          <div class="muted">æˆ¿é–“</div>
          <div class="big" id="room">â€”</div>
        </div>
        <div style="text-align:right">
          <div class="muted">å€’æ•¸</div>
          <div class="big" id="timer">â€”</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #223055;margin:14px 0"/>

      <div class="muted" id="progress">â€”</div>
      <div class="big" id="q">ç­‰å¾…é¡Œç›®â€¦</div>
      <div style="height:12px"></div>
      <div class="grid" id="choices"></div>
      <div style="height:12px"></div>
      <div class="muted" id="status">ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦</div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function () {
    function $(id){ return document.getElementById(id); }
    function setConn(ok){ $("conn").textContent = ok ? "å·²é€£ç·š" : "æœªé€£ç·š"; }

    function esc(s){
      return String(s).replace(/[&<>"']/g, function(m){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
      });
    }

    var params = new URLSearchParams(location.search);
    var socket = null;

    var roomCode = "";
    var userId = "";
    var displayName = "";
    var avatarUrl = "";

    var state = "lobby";
    var startAt = 0;
    var durationMs = 0;
    var answered = false;
    var correctIndex = null;
    var currentChoices = [];

    function cfg(cb){
      fetch("/config?role=player")
        .then(function(r){ return r.json(); })
        .then(function(j){ cb(null, j); })
        .catch(function(e){ cb(e); });
    }

    function initLiff(liffId, done){
      // Allow browser testing
      if (!window.liff || !liffId){
        userId = "guest-" + Math.random().toString(16).slice(2);
        displayName = "Guest";
        avatarUrl = "";
        $("hint").textContent = "âš ï¸ ä¸æ˜¯åœ¨ LINE LIFF æˆ–æœªè¨­å®š LIFF_IDï¼Œå·²ç”¨è¨ªå®¢æ¨¡å¼ï¼ˆä»å¯æ¸¬è©¦ï¼‰";
        return done();
      }

      liff.init({ liffId: liffId }).then(function(){
        if (!liff.isLoggedIn()){
          liff.login();
          return;
        }
        return liff.getProfile().then(function(p){
          userId = p.userId;
          displayName = p.displayName || "Guest";
          avatarUrl = p.pictureUrl || "";
          done();
        }).catch(function(){
          userId = "guest-" + Math.random().toString(16).slice(2);
          displayName = "Guest";
          avatarUrl = "";
          $("hint").textContent = "âš ï¸ å–å¾— LINE å€‹äººè³‡æ–™å¤±æ•—ï¼Œå·²ç”¨è¨ªå®¢æ¨¡å¼";
          done();
        });
      }).catch(function(){
        userId = "guest-" + Math.random().toString(16).slice(2);
        displayName = "Guest";
        avatarUrl = "";
        $("hint").textContent = "âš ï¸ LIFF init å¤±æ•—ï¼Œå·²ç”¨è¨ªå®¢æ¨¡å¼";
        done();
      });
    }

    function renderChoices(){
      var wrap = $("choices");
      wrap.innerHTML = "";
      var labels = ["A","B","C","D"];

      for (var i=0;i<currentChoices.length;i++){
        (function(idx){
          var c = currentChoices[idx];
          var b = document.createElement("button");
          b.className = "choice";
          b.disabled = (state !== "question") || answered;
          b.innerHTML = '<div class="muted">' + labels[idx] + '</div>'
                      + '<div style="font-size:18px;font-weight:900">' + esc(c) + '</div>';
          b.onclick = function(){ sendAns(idx); };
          wrap.appendChild(b);
        })(i);
      }
    }

    function onUpdate(s){
      roomCode = s.code;
      state = s.state;
      startAt = s.startAt || 0;
      durationMs = s.durationMs || 0;

      $("room").textContent = s.code;
      $("progress").textContent = "ç¬¬ " + (s.qIndex+1) + " / " + s.total + " é¡Œ";

      if (s.question){
        $("q").textContent = s.question.text;
        currentChoices = s.question.choices || [];
        renderChoices();
      } else {
        $("q").textContent = "ç­‰å¾…é¡Œç›®â€¦";
        $("choices").innerHTML = "";
      }

      if (state === "lobby"){ answered = false; correctIndex = null; $("status").textContent = "ç­‰å¾…ä¸»æŒäººé–‹å§‹â€¦"; }
      if (state === "question"){ answered = false; correctIndex = null; $("status").textContent = "è«‹é¸æ“‡ç­”æ¡ˆï¼"; }
      if (state === "reveal"){ $("status").textContent = "æ­æ›‰ï¼"; }
      if (state === "ended"){ $("status").textContent = "ğŸ‰ çµæŸï¼"; }
    }

    function joinRoom(){
      var code = ($("code").value || "").trim().toUpperCase();
      if (!code){ $("hint").textContent = "è«‹è¼¸å…¥æˆ¿é–“ç¢¼"; return; }
      $("hint").textContent = "åŠ å…¥ä¸­â€¦";

      socket.emit("player:join", {
        code: code,
        userId: userId,
        name: (displayName || "Guest"),
        avatarUrl: avatarUrl
      }, function(res){
        if (!(res && res.ok)){
          $("hint").textContent = "åŠ å…¥å¤±æ•—ï¼š" + ((res && res.error) || "");
          return;
        }
        $("joinCard").style.display = "none";
        $("gameCard").style.display = "";
        onUpdate(res.room);
      });
    }

    function sendAns(choiceIdx){
      if (answered || state !== "question") return;
      answered = true;
      $("status").textContent = "âœ… å·²é€å‡ºï¼Œç­‰å¾…æ­æ›‰â€¦";

      socket.emit("player:answer", { code: roomCode, userId: userId, choiceIndex: choiceIdx }, function(res){
        if (!(res && res.ok)) $("status").textContent = "âš ï¸ " + ((res && res.error) || "é€å‡ºå¤±æ•—");
      });
      renderChoices();
    }

    // timer
    setInterval(function(){
      if (state !== "question"){ $("timer").textContent = "â€”"; return; }
      var remain = Math.max(0, (startAt + durationMs) - Date.now());
      $("timer").textContent = Math.ceil(remain/1000) + "s";
    }, 200);

    function boot(config){
      socket = io();

      var urlCode = (params.get("code") || "").trim().toUpperCase();
      if (urlCode) $("code").value = urlCode;

      var autoJoined = false;

      socket.on("connect", function(){
        setConn(true);
        if (urlCode && !autoJoined){
          autoJoined = true;
          joinRoom();
        }
      });

      socket.on("disconnect", function(){ setConn(false); });
      socket.on("room:update", onUpdate);

      socket.on("question:reveal", function(p){
        correctIndex = p.correctIndex;
        var nodes = Array.prototype.slice.call(document.querySelectorAll(".choice"));
        for (var i=0;i<nodes.length;i++){
          nodes[i].classList.remove("good","bad");
          if (i === correctIndex) nodes[i].classList.add("good");
          else if (answered) nodes[i].classList.add("bad");
          nodes[i].disabled = true;
        }
      });

      $("joinBtn").onclick = joinRoom;
    }

    // start
    cfg(function(err, c){
      if (err){ $("hint").textContent = "âš ï¸ è®€å–è¨­å®šå¤±æ•—"; return; }
      initLiff(c.liffId || "", function(){ boot(c); });
    });
  })();
  </script>
</body>
</html>
