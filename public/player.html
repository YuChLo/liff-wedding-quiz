<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>婚禮問答 Player</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#0b0f1a;color:#eaf0ff}
    .wrap{max-width:720px;margin:0 auto;padding:16px}
    .card{background:#121a2b;border:1px solid #223055;border-radius:16px;padding:16px;margin:12px 0}
    input,button{font-size:16px}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #2a3b66;background:#0f1626;color:#eaf0ff}
    button{width:100%;padding:12px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:800}
    button:disabled{opacity:.55}
    .choice{position:relative;width:100%;text-align:left;background:#0f1626;border:2px solid #2a3b66;border-radius:14px;padding:14px}
    .good{border-color:#22c55e}
    .bad{border-color:#ef4444;opacity:.65}
    .picked{border-color:#60a5fa;box-shadow:0 0 0 2px rgba(96,165,250,.25)}
    .pickedWrong{border-color:#f59e0b;box-shadow:0 0 0 2px rgba(245,158,11,.25)}
    .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .big{font-size:22px;font-weight:900}
    .muted{opacity:.75}
    .grid{display:grid;gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="row">
      <div class="big">婚禮問答</div>
      <div class="muted" id="conn">連線中…</div>
    </div>

    <!-- Join: only employee id (room code comes from URL ?code=XXXXXX) -->
    <div class="card" id="joinCard">
      <div class="big">加入遊戲</div>
      <p class="muted" id="hint">請輸入工號（僅數字 4~10 碼）</p>
      <input id="emp" placeholder="請輸入工號（4~10 碼數字）" inputmode="numeric" pattern="[0-9]*"/>
      <div style="height:10px"></div>
      <button id="joinBtn">加入</button>
    </div>

    <div class="card" id="gameCard" style="display:none">
      <div class="row">
        <div>
          <div class="muted">房間</div>
          <div class="big" id="room">—</div>
        </div>
        <div style="text-align:right">
          <div class="muted">倒數</div>
          <div class="big" id="timer">—</div>
        </div>
      </div>

      <hr style="border:0;border-top:1px solid #223055;margin:14px 0"/>

      <div class="muted" id="progress">—</div>
      <div class="big" id="q">等待主持人按「下一題」開始…</div>
      <div style="height:12px"></div>
      <div class="grid" id="choices"></div>
      <div style="height:12px"></div>
      <div class="muted" id="status">等待主持人開始…</div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
  (function () {
    function $(id){ return document.getElementById(id); }
    function setConn(ok){ $("conn").textContent = ok ? "已連線" : "未連線"; }

    function esc(s){
      return String(s).replace(/[&<>"']/g, function(m){
        return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
      });
    }

    const params = new URLSearchParams(location.search);
    const roomCodeFromUrl = (params.get("code") || "").trim().toUpperCase();

    if (!roomCodeFromUrl) {
      document.body.innerHTML = "<div style='color:#fff;padding:24px'>房間連結錯誤，請重新掃描 QR Code</div>";
      return;
    }

    const socket = io();

    let roomCode = roomCodeFromUrl;
    let userId = "";
    let state = "lobby";
    let startAt = 0;
    let durationMs = 0;
    let serverOffsetMs = 0;

    let answered = false;
    let pickedIndex = null;
    let correctIndex = null;
    let currentChoices = [];
    let lastQIndex = null;

    function validateEmp(emp){
      if (!/^[0-9]+$/.test(emp)) return "工號只能輸入數字（不可英文/符號）";
      if (emp.length < 4 || emp.length > 10) return "工號長度需 4~10 碼";
      return "";
    }

    function renderChoices(){
      const wrap = $("choices");
      wrap.innerHTML = "";
      const labels = ["A","B","C","D"];

      for (let idx=0; idx<currentChoices.length; idx++){
        const c = currentChoices[idx];
        const b = document.createElement("button");
        b.className = "choice";
        if (answered && pickedIndex === idx) b.classList.add("picked");

        // Reveal coloring
        if (state === "reveal" && correctIndex !== null) {
          if (idx === correctIndex) b.classList.add("good");
          else b.classList.add("bad");

          if (pickedIndex === idx && pickedIndex !== correctIndex) b.classList.add("pickedWrong");
        }

        b.disabled = (state !== "question") || answered;
        b.innerHTML = '<div class="muted">' + labels[idx] + '</div>'
                    + '<div style="font-size:18px;font-weight:900">' + esc(c) + '</div>';
        b.onclick = function(){ sendAns(idx); };
        wrap.appendChild(b);
      }
    }

    function onUpdate(s){
      if (!s) return;
      roomCode = s.code || roomCode;
      state = s.state || "lobby";

      // reset per-question state on question change
      if (typeof s.qIndex !== "undefined" && s.qIndex !== lastQIndex) {
        lastQIndex = s.qIndex;
        answered = false;
        pickedIndex = null;
        correctIndex = null;
      }

      startAt = s.startAt || 0;
      durationMs = s.durationMs || 0;
      if (s.serverNow) serverOffsetMs = Date.now() - s.serverNow;

      $("room").textContent = roomCode;
      $("progress").textContent = "第 " + (Math.max(0,(s.qIndex||-1)+1)) + " / " + (s.total||0) + " 題";

      if (state === "ended") {
        $("q").textContent = "等待結果揭曉";
        $("choices").innerHTML = "";
        $("status").textContent = "等待結果揭曉…";
        return;
      }

      if (state === "lobby" || !s.question) {
        $("q").textContent = "等待主持人按「下一題」開始…";
        $("choices").innerHTML = "";
        $("status").textContent = "等待主持人開始…";
        return;
      }

      // question / reveal
      $("q").textContent = s.question.text || "";
      currentChoices = s.question.choices || [];
      renderChoices();

      if (state === "question") $("status").textContent = answered ? "✅ 已送出，等待揭曉…" : "請選擇答案！";
      if (state === "reveal") $("status").textContent = "揭曉！";
    }

    function joinRoom(){
      const emp = ($("emp").value || "").trim();
      const msg = validateEmp(emp);
      if (msg){ $("hint").textContent = msg; return; }

      $("hint").textContent = "加入中…";
      userId = "emp-" + emp;

      socket.emit("player:join", { code: roomCode, userId, name: emp }, function(res){
        if(!(res && res.ok)){
          $("hint").textContent = "加入失敗：" + ((res && res.error) || "");
          return;
        }
        $("joinCard").style.display="none";
        $("gameCard").style.display="";
        onUpdate(res.room);
      });
    }

    function sendAns(choiceIdx){
      if (answered || state !== "question") return;
      answered = true;
      pickedIndex = choiceIdx;
      renderChoices(); // immediately show picked blue
      $("status").textContent = "✅ 已送出，等待揭曉…";

      socket.emit("player:answer", { code: roomCode, userId, choiceIndex: choiceIdx }, function(res){
        if (!(res && res.ok)) $("status").textContent = "⚠️ " + ((res && res.error) || "送出失敗");
      });
    }

    // countdown (server-synced)
    setInterval(function(){
      if (state !== "question"){ $("timer").textContent = "—"; return; }
      const nowServer = Date.now() - serverOffsetMs;
      const remain = Math.max(0, (startAt + durationMs) - nowServer);
      $("timer").textContent = Math.ceil(remain/1000) + "s";
    }, 200);

    // socket events
    socket.on("connect", function(){ setConn(true); });
    socket.on("disconnect", function(){ setConn(false); });
    socket.on("room:update", onUpdate);

    // reveal: keep correctIndex and repaint (orange for wrong picked)
    socket.on("question:reveal", function(p){
      state = "reveal";
      correctIndex = (p && typeof p.correctIndex === "number") ? p.correctIndex : null;
      renderChoices();
      $("status").textContent = "揭曉！";
    });

    // UI events
    $("joinBtn").onclick = joinRoom;
    $("emp").addEventListener("keydown", function(e){ if (e.key === "Enter") joinRoom(); });

  })();
  </script>
</body>
</html>
