<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>婚禮問答 Display</title>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#050814;color:#eaf0ff}
.wrap{max-width:1200px;margin:0 auto;padding:22px}
.big{font-size:44px;font-weight:900;line-height:1.1}
.muted{opacity:.75}
.card{background:#0b1020;border:1px solid #223055;border-radius:20px;padding:18px;margin:14px 0}
.choices{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.choice{background:#0f1626;border:2px solid #2a3b66;border-radius:18px;padding:16px;font-size:26px;font-weight:800}
.good{border-color:#22c55e}
.bad{border-color:#ef4444}
.picked{border-color:#f59e0b}
table{width:100%;border-collapse:collapse;font-size:22px}
th,td{padding:10px;border-bottom:1px solid #223055;text-align:left}
.avatar{width:38px;height:38px;border-radius:50%;vertical-align:middle;margin-right:10px;object-fit:cover;background:#0f1626;border:1px solid #2a3b66}
.timer{font-size:44px;font-weight:900}
.row{display:flex;gap:18px;align-items:flex-start}
.col{flex:1}

#state{display:none}
</style></head><body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><div class="muted">房間碼</div><div class="big" id="code">—</div></div>
    <div><div class="muted">倒數</div><div class="timer" id="timer">—</div></div>
  </div>

  <div class="card">
    <div class="muted" id="progress">—</div>
    <div class="big" id="q">等待題目…</div>
    <div class="choices" id="choices"></div>
    <div class="muted" id="state">—</div>
  </div>

  <div class="row">
    <div class="col card">
      <div class="big" style="font-size:32px">排行榜（前10）</div>
      <table><thead><tr><th>#</th><th>玩家</th><th>分數</th></tr></thead><tbody id="lb"></tbody></table>
    </div>
    <div class="col card">
      <div class="big" style="font-size:32px">目前人數</div>
      <div class="big" id="answers" style="font-size:64px">0</div>
    </div>
  </div>
</div>


<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
(function () {
  function qs(name) { return new URLSearchParams(location.search).get(name) || ""; }
  var code = (qs("code") || "").toUpperCase();

  var $code = document.getElementById("code");
  var $timer = document.getElementById("timer");
  var $progress = document.getElementById("progress");
  var $q = document.getElementById("q");
  var $answers = document.getElementById("answers");
  var $lb = document.getElementById("lb");

  if ($code) $code.textContent = code || "----";

  function setChoiceText(i, label, text) {
    var el = document.getElementById("c" + i);
    if (!el) return;
    el.classList.remove("good", "bad", "picked");
    el.textContent = label + " " + (text || "");
  }

  function clearChoices() {
    for (var i = 0; i < 4; i++) setChoiceText(i, ["A","B","C","D"][i], "");
  }

  function renderLeaderboard(players) {
    if (!$lb) return;
    var rows = "";
    var list = (players || []).slice().sort(function(a,b){ return (b.score||0)-(a.score||0); }).slice(0,10);
    for (var i=0;i<list.length;i++){
      var p=list[i] || {};
      var name = (p.name || p.playerId || ("P"+(i+1))).toString();
      name = name.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
      rows += "<tr><td>"+(i+1)+"</td><td>"+name+"</td><td>"+(p.score||0)+"</td></tr>";
    }
    $lb.innerHTML = rows || "<tr><td colspan='3' class='muted'>—</td></tr>";
  }

  function renderState(s) {
    s = s || {};
    var total = (s.totalQuestions != null) ? s.totalQuestions : 5;
    var idx = (s.currentIndex != null) ? s.currentIndex : 0;
    var status = s.status || "lobby";
    var remaining = (s.remaining != null) ? s.remaining : null;

    // ALWAYS show player count immediately
    var pc = 0;
    if (Array.isArray(s.players)) pc = s.players.length;
    else if (typeof s.playerCount === "number") pc = s.playerCount;
    if ($answers) $answers.textContent = String(pc);

    if ($timer) $timer.textContent = (remaining == null) ? "—" : (String(remaining) + "s");
    if ($progress) $progress.textContent = "第 " + idx + " / " + total + " 題";

    if (status === "lobby") {
      if ($q) $q.textContent = "等待主持人按「下一題」開始...";
      clearChoices();
      renderLeaderboard(s.players || []);
      return;
    }

    if (status === "ended") {
      if ($q) $q.textContent = "等待結果揭曉";
      clearChoices();
      renderLeaderboard(s.players || []);
      return;
    }

    // question / reveal
    if ($q) $q.textContent = (s.question && s.question.text) ? s.question.text : "—";
    var ch = (s.question && s.question.choices) ? s.question.choices : ["","","",""];
    for (var i=0;i<4;i++) setChoiceText(i, ["A","B","C","D"][i], ch[i] || "");

    if (status === "reveal" && typeof s.correctIndex === "number") {
      for (var j=0;j<4;j++){
        var el = document.getElementById("c"+j);
        if (!el) continue;
        el.classList.add(j === s.correctIndex ? "good" : "bad");
      }
    }

    renderLeaderboard(s.players || []);
  }

  if (!code) {
    renderState({status:"lobby", currentIndex:0, totalQuestions:5, players:[]});
    return;
  }

  var socket = io({ transports: ["websocket", "polling"] });

  socket.on("connect", function () {
    socket.emit("room:watch", { code: code, role: "display" });
  });

  socket.on("room:snapshot", function (s) { renderState(s); });
  socket.on("room:update", function (s) { renderState(s); });

  // Keep player count in sync even before host starts (in case some events missed)
  setInterval(function () {
    if (socket && socket.connected) socket.emit("room:watch", { code: code, role: "display" });
  }, 1500);
})();
</script>

</body></html>
