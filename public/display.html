<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>婚禮問答 Display</title>
<style>
  body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#050814;color:#eaf0ff}
  .wrap{max-width:1200px;margin:0 auto;padding:22px}
  .big{font-size:44px;font-weight:900;line-height:1.1}
  .muted{opacity:.75}
  .card{background:#0b1020;border:1px solid #223055;border-radius:20px;padding:18px;margin:14px 0}
  .choices{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
  .choice{background:#0f1626;border:2px solid #2a3b66;border-radius:18px;padding:16px;font-size:26px;font-weight:800}
  .choice.good{border-color:#22c55e;background:linear-gradient(135deg, rgba(34,197,94,.20), rgba(34,197,94,.06));box-shadow:0 0 0 4px rgba(34,197,94,.35), 0 0 28px rgba(34,197,94,.35);transform:scale(1.02);}
.choice.good{position:relative;}
.choice.good::after{content:"✔ 正確";position:absolute;top:12px;right:14px;font-size:18px;font-weight:900;color:#bbf7d0;background:rgba(34,197,94,.22);border:1px solid rgba(34,197,94,.55);padding:6px 10px;border-radius:999px;}
  .choice.bad{border-color:#ef4444;opacity:.55;filter:saturate(.8);}
  .timer{font-size:44px;font-weight:900}
  .row{display:flex;gap:18px;align-items:flex-start}
  .col{flex:1}
  table{width:100%;border-collapse:collapse;font-size:22px}
  th,td{padding:10px;border-bottom:1px solid #223055;text-align:left}
  #state{display:none} /* hide status line per request */
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="muted">房間碼</div>
      <div class="big" id="code">—</div>
    </div>
    <div>
      <div class="muted">倒數</div>
      <div class="timer" id="timer">—</div>
    </div>
  </div>

  <div class="card">
    <div class="muted" id="progress">—</div>
    <div class="big" id="q">等待主持人按「下一題」開始…</div>
    <div class="choices" id="choices"></div>
    <div class="muted" id="state">—</div>
  </div>

  <div class="row">
    <div class="col card">
      <div class="big" style="font-size:32px">排行榜（前10）</div>
      <table>
        <thead><tr><th>#</th><th>玩家</th><th>分數</th></tr></thead>
        <tbody id="lb"></tbody>
      </table>
    </div>
    <div class="col card">
      <div class="big" style="font-size:32px">目前人數</div>
      <div class="big" id="players" style="font-size:64px">0</div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  function $(id){ return document.getElementById(id); }
  function esc(s){
    return String(s).replace(/[&<>"']/g, function(m){
      return ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" })[m];
    });
  }

  var params = new URLSearchParams(location.search);
  var code = (params.get("code") || "").toUpperCase();
  $("code").textContent = code || "----";

  var state = "lobby";
  var startAt = 0;
  var durationMs = 0;
  var serverOffsetMs = 0;

  function renderLeaderboard(players){
    var body = $("lb");
    if(!body) return;
    var list = (players||[]).slice().sort(function(a,b){ return (b.score||0)-(a.score||0); }).slice(0,10);
    var rows = "";
    for(var i=0;i<list.length;i++){
      var p=list[i]||{};
      var name = esc(p.name || p.playerId || ("P"+(i+1)));
      rows += "<tr><td>"+(i+1)+"</td><td>"+name+"</td><td>"+(p.score||0)+"</td></tr>";
    }
    body.innerHTML = rows || "<tr><td colspan='3' class='muted'>—</td></tr>";
  }

  function renderChoices(question, correctIndex){
    var wrap = $("choices");
    if(!wrap) return;
    wrap.innerHTML = "";
    var labels = ["A","B","C","D"];
    var choices = (question && question.choices) ? question.choices : [];
    for(var i=0;i<choices.length;i++){
      var d = document.createElement("div");
      d.className = "choice";
      d.innerHTML = "<div class='muted'>"+labels[i]+"</div><div>"+esc(choices[i])+"</div>";
      if(state === "reveal" && typeof correctIndex === "number"){
        d.classList.add(i===correctIndex ? "good" : "bad");
      }
      wrap.appendChild(d);
    }
  }

  function applySnapshot(s){
    if(!s) return;

    // player count should update even in lobby
    var pc = (typeof s.playersCount === "number") ? s.playersCount :
             (Array.isArray(s.players) ? s.players.length : 0);
    $("players").textContent = String(pc);

    state = s.state || "lobby";
    startAt = s.startAt || 0;
    durationMs = s.durationMs || 0;
    if(s.serverNow) serverOffsetMs = Date.now() - s.serverNow;

    var idx = (typeof s.qIndex === "number") ? s.qIndex : -1;
    var total = (typeof s.total === "number") ? s.total : (s.questionsTotal || 0);
    $("progress").textContent = (idx>=0 && total>0) ? ("第 " + (idx+1) + " / " + total + " 題") : "—";

    // hide question in lobby until host starts
    if(state === "lobby" || !s.question){
      $("q").textContent = "等待主持人按「下一題」開始…";
      $("choices").innerHTML = "";
      renderLeaderboard(s.players || []);
      return;
    }

    if(state === "ended"){
      $("q").textContent = "等待結果揭曉";
      $("choices").innerHTML = "";
      renderLeaderboard(s.players || []);
      return;
    }

    // question / reveal
    $("q").textContent = (s.question && s.question.text) ? s.question.text : "—";
    renderChoices(s.question, s.correctIndex);
    renderLeaderboard(s.players || []);
  }

  var socket = io("/", {
    path: "/socket.io",
    transports: ["polling","websocket"],
    upgrade: true,
    timeout: 20000,
    reconnection: true
  });

  socket.on("connect", function(){
    if(!code){ applySnapshot({state:"lobby", playersCount:0}); return; }
    socket.emit("display:join", { code: code }, function(res){
      if(res && res.ok) applySnapshot(res.room);
    });
  });

  socket.on("room:update", function(s){
    if(s && s.code && s.code.toUpperCase() !== code) return;
    applySnapshot(s);
  });

  socket.on("question:reveal", ({ correctIndex }) => {
    state = "reveal";
    renderChoices(lastQuestion, correctIndex);
  });

  // keep in sync pre-start (in case events missed)
  setInterval(function(){
    if(!code) return;
    if(socket && socket.connected){
      socket.emit("display:join", { code: code }, function(res){
        if(res && res.ok) applySnapshot(res.room);
      });
    }
  }, 1500);

  // countdown like player (server-synced)
  setInterval(function(){
    if(state !== "question"){ $("timer").textContent = "—"; return; }
    var nowServer = Date.now() - serverOffsetMs;
    var remain = Math.max(0, (startAt + durationMs) - nowServer);
    $("timer").textContent = Math.ceil(remain/1000) + "s";
  }, 200);

})();
</script>
</body>
</html>
