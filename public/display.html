<!doctype html><html lang="zh-Hant"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>婚禮問答 Display</title>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#050814;color:#eaf0ff}
.wrap{max-width:1200px;margin:0 auto;padding:22px}
.big{font-size:44px;font-weight:900;line-height:1.1}
.muted{opacity:.75}
.card{background:#0b1020;border:1px solid #223055;border-radius:20px;padding:18px;margin:14px 0}
.choices{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.choice{background:#0f1626;border:2px solid #2a3b66;border-radius:18px;padding:16px;font-size:26px;font-weight:800}
.good{border-color:#22c55e}
table{width:100%;border-collapse:collapse;font-size:22px}
th,td{padding:10px;border-bottom:1px solid #223055;text-align:left}
.avatar{width:38px;height:38px;border-radius:50%;vertical-align:middle;margin-right:10px;object-fit:cover;background:#0f1626;border:1px solid #2a3b66}
.timer{font-size:44px;font-weight:900}
.row{display:flex;gap:18px;align-items:flex-start}
.col{flex:1}
</style></head><body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><div class="muted">房間碼</div><div class="big" id="code">—</div></div>
    <div><div class="muted">倒數</div><div class="timer" id="timer">—</div></div>
  </div>

  <div class="card">
    <div class="muted" id="progress">—</div>
    <div class="big" id="q">等待題目…</div>
    <div class="choices" id="choices"></div>
    <div class="muted" id="state">—</div>
  </div>

  <div class="row">
    <div class="col card">
      <div class="big" style="font-size:32px">排行榜（前10）</div>
      <table><thead><tr><th>#</th><th>玩家</th><th>分數</th></tr></thead><tbody id="lb"></tbody></table>
    </div>
    <div class="col card">
      <div class="big" style="font-size:32px">目前人數</div>
      <div class="big" id="players" style="font-size:64px">0</div>
    </div>
    <div class="col card">
      <div class="big" style="font-size:32px">回覆數</div>
      <div class="big" id="answers" style="font-size:64px">0</div>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const $=id=>document.getElementById(id);
const params=new URLSearchParams(location.search);
const roomCode=(params.get("code")||"").toUpperCase();
$("code").textContent = roomCode || "（加 ?code=房間碼）";

let state="lobby", startAt=0, durationMs=0, correctIndex=null;

const socket=io();
socket.on("connect", ()=>{
  if(roomCode) socket.emit("display:join",{ code: roomCode },()=>{});
});
socket.on("room:update",(s)=>{
  if(roomCode && s.code && s.code!==roomCode) return;
  state=s.state; startAt=s.startAt||0; durationMs=s.durationMs||0; correctIndex=null;
  $("answers").textContent=s.answersCount||0;
  if (typeof s.playersCount === "number") $("players").textContent = s.playersCount;
  $("progress").textContent = "第 " + (s.qIndex+1) + " / " + s.total + " 題";
  $("state").textContent = state==="question"?"答題中":(state==="reveal"?"揭曉":(state==="ended"?"結束":"等待"));
  if(s.question){
    $("q").textContent=s.question.text;
    const labels=["A","B","C","D"];
    $("choices").innerHTML="";
    s.question.choices.forEach((c,i)=>{
      const d=document.createElement("div");
      d.className="choice";
      d.textContent=labels[i]+"  "+c;
      $("choices").appendChild(d);
    });
  } else {
    $("q").textContent="等待題目…";
    $("choices").innerHTML="";
  }
  const lb=$("lb"); lb.innerHTML="";
  (s.players||[]).slice(0,10).forEach((p,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = "<td>" + (i+1) + "</td><td>" + (p.avatarUrl ? ('<img class="avatar" referrerpolicy="no-referrer" src="' + p.avatarUrl + '"/>') : "") + p.name + "</td><td>" + p.score + "</td>";
    lb.appendChild(tr);
  });
});
socket.on("room:answersCount",(p)=>{$("answers").textContent=p.answersCount||$("answers").textContent;});
socket.on("question:reveal",(p)=>{
  correctIndex=p.correctIndex;
  [...document.querySelectorAll(".choice")].forEach((n,idx)=>{ if(idx===correctIndex) n.classList.add("good"); });
});
setInterval(()=>{
  if(state!=="question"){ $("timer").textContent="—"; return; }
  const remain=Math.max(0,(startAt+durationMs)-Date.now());
  $("timer").textContent=Math.ceil(remain/1000)+"s";
},200);
</script></body></html>
