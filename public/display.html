<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>婚禮問答 Display</title>
<style>
body{font-family:system-ui,"Noto Sans TC",sans-serif;margin:0;background:#050814;color:#eaf0ff}
.wrap{max-width:1200px;margin:0 auto;padding:22px}
.big{font-size:44px;font-weight:900;line-height:1.1}
.muted{opacity:.75}
.card{background:#0b1020;border:1px solid #223055;border-radius:20px;padding:18px;margin:14px 0}
.choices{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:16px}
.choice{background:#0f1626;border:2px solid #2a3b66;border-radius:18px;padding:16px;font-size:26px;font-weight:800}
.choice.good{border-color:#22c55e;box-shadow:0 0 0 3px rgba(34,197,94,.45)}
.choice.bad{border-color:#ef4444;opacity:.75}
.timer{font-size:44px;font-weight:900}
</style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div class="muted">房間碼</div>
      <div class="big" id="code">—</div>
    </div>
    <div>
      <div class="muted">倒數</div>
      <div class="timer" id="timer">—</div>
    </div>
  </div>

  <div class="card">
    <div class="muted" id="progress">—</div>
    <div class="big" id="q">等待主持人開始…</div>
    <div class="choices" id="choices"></div>
  </div>

  <div class="card">
    <div class="big" style="font-size:32px">目前人數</div>
    <div class="big" id="players" style="font-size:64px">0</div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
(function(){
  const $ = id => document.getElementById(id);
  const params = new URLSearchParams(location.search);
  const code = (params.get("code")||"").toUpperCase();
  $("code").textContent = code || "----";

  let state="lobby";
  let correctIndex=null;
  let lastQuestion=null;
  let startAt=0, durationMs=0, serverOffsetMs=0;

  function render(){
    if(!lastQuestion || state==="lobby"){
      $("q").textContent="等待主持人開始…";
      $("choices").innerHTML="";
      return;
    }
    if(state==="ended"){
      $("q").textContent="等待結果揭曉";
      $("choices").innerHTML="";
      return;
    }
    $("q").textContent = lastQuestion.text || "";
    $("choices").innerHTML="";
    const labels=["A","B","C","D"];
    lastQuestion.choices.forEach((c,i)=>{
      const d=document.createElement("div");
      d.className="choice";
      d.innerHTML="<div class='muted'>"+labels[i]+"</div><div>"+c+"</div>";
      if(state==="reveal" && typeof correctIndex==="number"){
        d.classList.add(i===correctIndex?"good":"bad");
      }
      $("choices").appendChild(d);
    });
  }

  const socket = io("/", {
    transports:["polling","websocket"],
    upgrade:true,
    timeout:20000
  });

  socket.on("connect", ()=>{
    if(!code) return;
    socket.emit("display:join",{code}, res=>{
      if(res?.ok){
        const s=res.room;
        state=s.state;
        lastQuestion=s.question||null;
        $("players").textContent=s.playersCount||0;
        startAt=s.startAt||0;
        durationMs=s.durationMs||0;
        if(s.serverNow) serverOffsetMs=Date.now()-s.serverNow;
        render();
      }
    });
  });

  socket.on("room:update", s=>{
    if(!s || s.code!==code) return;
    state=s.state;
    if(s.question) lastQuestion=s.question;
    if(typeof s.correctIndex==="number") correctIndex=s.correctIndex;
    $("players").textContent=s.playersCount||0;
    startAt=s.startAt||0;
    durationMs=s.durationMs||0;
    if(s.serverNow) serverOffsetMs=Date.now()-s.serverNow;
    render();
  });

    socket.on("question:reveal", function(p){
    if(!p) return;
    state = "reveal";
    if(typeof p.correctIndex === "number") correctIndexGlobal = p.correctIndex;
    if(lastQuestion) renderChoices(lastQuestion, correctIndexGlobal);
    if(p.top10) renderLeaderboard(p.top10);
  });
  });

  setInterval(()=>{
    if(state!=="question"){ $("timer").textContent="—"; return; }
    const nowServer=Date.now()-serverOffsetMs;
    const remain=Math.max(0,(startAt+durationMs)-nowServer);
    $("timer").textContent=Math.ceil(remain/1000)+"s";
  },200);
})();
</script>
</body>
</html>
